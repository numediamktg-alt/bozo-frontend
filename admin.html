<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Bozo on the Bus</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: #d4af37; margin-bottom: 20px; }
        h2 { color: #d4af37; font-size: 1.1rem; margin-bottom: 15px; }
        
        .login-box, .admin-panel { display: none; }
        .login-box.active, .admin-panel.active { display: block; }
        
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        input, select {
            padding: 10px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #d4af37;
        }
        input::placeholder { color: rgba(255,255,255,0.4); }
        
        button, .btn {
            padding: 10px 20px;
            background: #d4af37;
            color: #1a1a2e;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover, .btn:hover { background: #c4a030; }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-danger { background: #e74c3c; color: #fff; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #555; color: #fff; }
        .btn-secondary:hover { background: #666; }
        
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: rgba(212,175,55,0.1);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 8px;
            padding: 15px 25px;
            text-align: center;
        }
        .stat-box .number {
            font-size: 2rem;
            font-weight: bold;
            color: #d4af37;
        }
        .stat-box .label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
        }
        
        .add-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .add-form .field { display: flex; flex-direction: column; gap: 5px; }
        .add-form .field label { font-size: 12px; color: rgba(255,255,255,0.6); }
        .add-form .field input { width: 200px; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            text-align: left;
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            color: rgba(255,255,255,0.6);
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
        }
        tr:hover { background: rgba(255,255,255,0.03); }
        
        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        .message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
            display: block;
        }
        .message.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
            display: block;
        }
        
        .actions { display: flex; gap: 8px; }
        
        select.status-select {
            padding: 6px 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Panel</h1>
        
        <!-- Login -->
        <div class="login-box active" id="login-box">
            <div class="card">
                <h2>Enter API Secret</h2>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <input type="password" id="secret" placeholder="Your API_SECRET from Railway" style="flex: 1;">
                    <button onclick="login()">Login</button>
                </div>
                <div id="login-error" class="message" style="margin-top: 15px;"></div>
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div class="admin-panel" id="admin-panel">
            <div id="message" class="message"></div>
            
            <!-- Stats -->
            <div class="stats-row" id="stats-row">
                <div class="stat-box">
                    <div class="number" id="stat-active">-</div>
                    <div class="label">Active</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="stat-total">-</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="stat-readings">-</div>
                    <div class="label">Readings</div>
                </div>
            </div>
            
            <!-- Add Subscriber -->
            <div class="card">
                <h2>Add Free Subscriber</h2>
                <form class="add-form" id="add-form">
                    <div class="field">
                        <label>Email</label>
                        <input type="email" id="new-email" placeholder="friend@example.com" required>
                    </div>
                    <div class="field">
                        <label>Name (optional)</label>
                        <input type="text" id="new-name" placeholder="Name">
                    </div>
                    <button type="submit">Add Subscriber</button>
                </form>
            </div>
            
            <!-- Add Quote -->
            <div class="card">
                <h2>üìú Add New Quote</h2>
                <form class="add-form" id="add-quote-form">
                    <div class="field">
                        <label>Quote Text</label>
                        <textarea id="quote-text" placeholder="Your wisdom..." rows="3" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(0,0,0,0.3); color: #fff; font-size: 14px; resize: vertical;" required></textarea>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                        <div class="field" style="flex: 1;">
                            <label>Date Written</label>
                            <input type="date" id="quote-date" required style="width: 100%;">
                        </div>
                        <div class="field" style="flex: 1;">
                            <label>Time (optional - for high-fidelity)</label>
                            <input type="time" id="quote-time" placeholder="HH:MM" style="width: 100%;">
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #888; margin: 10px 0;">
                        üì° Adding exact time creates a "high-fidelity" quote with more precise cosmic fingerprint.
                    </p>
                    <button type="submit">Add Quote</button>
                </form>
            </div>
            
            <!-- Subscribers List -->
            <div class="card">
                <h2>All Subscribers</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Birth Data</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr><td colspan="5" style="text-align: center; color: #888;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Backup & Restore -->
            <div class="card">
                <h2>üíæ Backup & Restore</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    
                    <!-- Subscribers Backup -->
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        <h3 style="font-size: 14px; color: #d4af37; margin-bottom: 10px;">üìã Subscribers Database</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="backupSubscribers()" class="btn-small">‚¨áÔ∏è Download Backup</button>
                            <div>
                                <input type="file" id="restore-subscribers-file" accept=".json" style="display: none;" onchange="restoreSubscribers(this)">
                                <button onclick="document.getElementById('restore-subscribers-file').click()" class="btn-small btn-secondary">‚¨ÜÔ∏è Restore from File</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quotes Backup -->
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        <h3 style="font-size: 14px; color: #d4af37; margin-bottom: 10px;">üìú Quotes Database</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="backupQuotes()" class="btn-small">‚¨áÔ∏è Download Backup</button>
                            <div>
                                <input type="file" id="restore-quotes-file" accept=".json" style="display: none;" onchange="restoreQuotes(this)">
                                <button onclick="document.getElementById('restore-quotes-file').click()" class="btn-small btn-secondary">‚¨ÜÔ∏è Restore from File</button>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <p style="margin-top: 15px; font-size: 12px; color: #888;">
                    üí° Tip: Download backups regularly. Restore if database gets wiped after Railway redeploy.
                </p>
            </div>
            
            <!-- Quote Editor Link -->
            <div class="card" style="background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(212,175,55,0.05)); border-color: rgba(212,175,55,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin-bottom: 5px;">üìú Quote Database Editor</h2>
                        <p style="color: #888; font-size: 13px; margin: 0;">Browse, search, edit, and manage all 529+ quotes</p>
                    </div>
                    <button onclick="showQuoteEditor()" class="btn">Open Editor ‚Üí</button>
                </div>
            </div>
            
            <button class="btn-secondary" onclick="logout()" style="margin-top: 10px;">Logout</button>
            
            <!-- Quote Editor Modal -->
            <div id="quote-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
                <div style="max-width: 700px; margin: 50px auto; background: #1a1a2e; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 30px;">
                    <h2 style="color: #d4af37; margin-bottom: 20px;">‚úèÔ∏è Edit Quote #<span id="edit-quote-id"></span></h2>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #888;">Quote Text</label>
                        <textarea id="edit-quote-text" rows="5" style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(0,0,0,0.3); color: #fff; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; color: #888;">Date Written</label>
                            <input type="date" id="edit-quote-date" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(0,0,0,0.3); color: #fff;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; color: #888;">Time (optional)</label>
                            <input type="time" id="edit-quote-time" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(0,0,0,0.3); color: #fff;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeQuoteModal()" class="btn-secondary">Cancel</button>
                        <button onclick="saveQuoteEdit()" class="btn">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quote Editor Panel (separate from main admin) -->
        <div class="quote-editor-panel" id="quote-editor-panel" style="display: none;">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h1>üìú Quote Editor</h1>
                    <button onclick="showMainAdmin()" class="btn-secondary">‚Üê Back to Admin</button>
                </div>
                
                <div id="quote-message" class="message"></div>
                
                <!-- Search & Stats -->
                <div class="card">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="quote-search" placeholder="Search quotes by text or ID..." style="width: 100%;" onkeyup="if(event.key==='Enter')searchQuotes()">
                        </div>
                        <button onclick="searchQuotes()" class="btn-small">üîç Search</button>
                        <button onclick="loadQuotes(1)" class="btn-small btn-secondary">Show All</button>
                        <button onclick="showIssuesOnly()" class="btn-small" style="background: #e74c3c;">‚ö†Ô∏è Show Issues</button>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 20px;">
                        <span style="color: #888;">Total: <strong id="quote-total" style="color: #d4af37;">-</strong></span>
                        <span style="color: #888;">Page: <strong id="quote-page-info" style="color: #fff;">-</strong></span>
                    </div>
                </div>
                
                <!-- Quotes List -->
                <div class="card">
                    <div id="quotes-list" style="max-height: 600px; overflow-y: auto;">
                        <p style="color: #888; text-align: center;">Click "Show All" or search to load quotes</p>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="quote-pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://bozo-oracle-production.up.railway.app';
        let apiSecret = '';
        let currentQuotePage = 1;
        let currentQuoteSearch = '';
        let editingQuoteId = null;
        
        // Known issues for flagging
        const KNOWN_ISSUES = {
            // Merged quotes
            45: 'MERGED - contains quote #46',
            153: 'MERGED - contains embedded number',
            366: 'MERGED - contains quote #367',
            415: 'MERGED - may contain multiple quotes',
            575: 'MERGED - contains quote #576',
            // Artifacts
            85: 'ARTIFACT - embedded date .11/20.88\\',
            88: 'ARTIFACT - embedded date',
            121: 'ARTIFACT - embedded backslashes',
            178: 'ARTIFACT - embedded date',
            191: 'ARTIFACT - embedded date',
            551: 'ARTIFACT - embedded date',
            577: 'ARTIFACT - embedded date',
            // Incomplete
            96: 'INCOMPLETE - truncated ending',
            105: 'INCOMPLETE - truncated ending',
            113: 'INCOMPLETE - missing punctuation',
            126: 'INCOMPLETE - missing period',
            128: 'INCOMPLETE - missing period',
            292: 'INCOMPLETE - truncated, starts lowercase',
            392: 'INCOMPLETE - missing beginning',
            409: 'INCOMPLETE - missing beginning',
            516: 'INCOMPLETE - missing beginning',
            // Duplicate
            459: 'DUPLICATE - same as #458'
        };
        
        function showQuoteEditor() {
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('quote-editor-panel').style.display = 'block';
            loadQuotes(1);
        }
        
        function showMainAdmin() {
            document.getElementById('quote-editor-panel').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
        }
        
        async function loadQuotes(page) {
            currentQuotePage = page;
            var list = document.getElementById('quotes-list');
            list.innerHTML = '<p style="color: #888; text-align: center;">Loading...</p>';
            
            try {
                var url = API_BASE + '/api/admin/quotes?secret=' + encodeURIComponent(apiSecret) + '&page=' + page + '&limit=20';
                if (currentQuoteSearch) {
                    url += '&search=' + encodeURIComponent(currentQuoteSearch);
                }
                
                var res = await fetch(url);
                if (!res.ok) throw new Error('Failed to load quotes');
                
                var data = await res.json();
                
                document.getElementById('quote-total').textContent = data.total;
                document.getElementById('quote-page-info').textContent = data.page + ' of ' + data.pages;
                
                if (data.quotes.length === 0) {
                    list.innerHTML = '<p style="color: #888; text-align: center;">No quotes found</p>';
                    return;
                }
                
                var html = '';
                for (var q of data.quotes) {
                    var issue = KNOWN_ISSUES[q.id] || '';
                    var issueHtml = issue ? '<span style="background: #e74c3c; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">' + issue + '</span>' : '';
                    var hiFi = q.is_high_fidelity ? '<span style="background: #27ae60; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">üì° HiFi</span>' : '';
                    
                    html += '<div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); ' + (issue ? 'background: rgba(231,76,60,0.1);' : '') + '">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">';
                    html += '<div style="flex: 1;">';
                    html += '<div style="margin-bottom: 8px;"><strong style="color: #d4af37;">#' + q.id + '</strong> <span style="color: #888; font-size: 12px;">' + q.date + '</span>' + hiFi + issueHtml + '</div>';
                    html += '<div style="color: #fff; line-height: 1.5;">' + escapeHtml(q.text) + '</div>';
                    html += '</div>';
                    html += '<div style="display: flex; gap: 8px; flex-shrink: 0;">';
                    html += '<button onclick="editQuote(' + q.id + ')" class="btn-small">‚úèÔ∏è</button>';
                    html += '<button onclick="deleteQuote(' + q.id + ')" class="btn-small btn-danger">üóëÔ∏è</button>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                list.innerHTML = html;
                
                // Pagination
                var pagHtml = '';
                if (data.page > 1) {
                    pagHtml += '<button onclick="loadQuotes(' + (data.page - 1) + ')" class="btn-small btn-secondary">‚Üê Prev</button>';
                }
                pagHtml += '<span style="color: #888; padding: 0 15px;">Page ' + data.page + ' of ' + data.pages + '</span>';
                if (data.page < data.pages) {
                    pagHtml += '<button onclick="loadQuotes(' + (data.page + 1) + ')" class="btn-small btn-secondary">Next ‚Üí</button>';
                }
                document.getElementById('quote-pagination').innerHTML = pagHtml;
                
            } catch (e) {
                list.innerHTML = '<p style="color: #e74c3c; text-align: center;">Error loading quotes: ' + e.message + '</p>';
            }
        }
        
        function searchQuotes() {
            currentQuoteSearch = document.getElementById('quote-search').value.trim();
            loadQuotes(1);
        }
        
        function showIssuesOnly() {
            // Load all and filter to issues
            currentQuoteSearch = '';
            document.getElementById('quote-search').value = '';
            loadQuotesWithIssues();
        }
        
        async function loadQuotesWithIssues() {
            var list = document.getElementById('quotes-list');
            list.innerHTML = '<p style="color: #888; text-align: center;">Loading issues...</p>';
            
            try {
                var res = await fetch(API_BASE + '/api/admin/quotes?secret=' + encodeURIComponent(apiSecret) + '&page=1&limit=1000');
                if (!res.ok) throw new Error('Failed to load quotes');
                
                var data = await res.json();
                var issueQuotes = data.quotes.filter(function(q) { return KNOWN_ISSUES[q.id]; });
                
                document.getElementById('quote-total').textContent = issueQuotes.length + ' issues';
                document.getElementById('quote-page-info').textContent = 'Showing all issues';
                
                if (issueQuotes.length === 0) {
                    list.innerHTML = '<p style="color: #27ae60; text-align: center;">‚úì No known issues!</p>';
                    return;
                }
                
                var html = '';
                for (var q of issueQuotes) {
                    var issue = KNOWN_ISSUES[q.id] || '';
                    var issueHtml = '<span style="background: #e74c3c; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">' + issue + '</span>';
                    
                    html += '<div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(231,76,60,0.1);">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">';
                    html += '<div style="flex: 1;">';
                    html += '<div style="margin-bottom: 8px;"><strong style="color: #d4af37;">#' + q.id + '</strong> <span style="color: #888; font-size: 12px;">' + q.date + '</span>' + issueHtml + '</div>';
                    html += '<div style="color: #fff; line-height: 1.5;">' + escapeHtml(q.text) + '</div>';
                    html += '</div>';
                    html += '<div style="display: flex; gap: 8px; flex-shrink: 0;">';
                    html += '<button onclick="editQuote(' + q.id + ')" class="btn-small">‚úèÔ∏è</button>';
                    html += '<button onclick="deleteQuote(' + q.id + ')" class="btn-small btn-danger">üóëÔ∏è</button>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                list.innerHTML = html;
                document.getElementById('quote-pagination').innerHTML = '';
                
            } catch (e) {
                list.innerHTML = '<p style="color: #e74c3c; text-align: center;">Error: ' + e.message + '</p>';
            }
        }
        
        async function editQuote(id) {
            editingQuoteId = id;
            
            try {
                var res = await fetch(API_BASE + '/api/admin/quote/' + id + '?secret=' + encodeURIComponent(apiSecret));
                if (!res.ok) throw new Error('Failed to load quote');
                
                var q = await res.json();
                
                document.getElementById('edit-quote-id').textContent = id;
                document.getElementById('edit-quote-text').value = q.text;
                document.getElementById('edit-quote-date').value = q.date;
                document.getElementById('edit-quote-time').value = q.time || '';
                
                document.getElementById('quote-modal').style.display = 'block';
            } catch (e) {
                alert('Error loading quote: ' + e.message);
            }
        }
        
        function closeQuoteModal() {
            document.getElementById('quote-modal').style.display = 'none';
            editingQuoteId = null;
        }
        
        async function saveQuoteEdit() {
            if (!editingQuoteId) return;
            
            var text = document.getElementById('edit-quote-text').value.trim();
            var date = document.getElementById('edit-quote-date').value;
            var time = document.getElementById('edit-quote-time').value || null;
            
            if (!text || !date) {
                alert('Text and date are required');
                return;
            }
            
            try {
                var res = await fetch(API_BASE + '/api/admin/quote/' + editingQuoteId + '?secret=' + encodeURIComponent(apiSecret), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, date: date, time: time })
                });
                
                if (!res.ok) {
                    var err = await res.json();
                    throw new Error(err.detail || 'Failed to save');
                }
                
                closeQuoteModal();
                showQuoteMessage('Updated quote #' + editingQuoteId, 'success');
                loadQuotes(currentQuotePage);
                
            } catch (e) {
                alert('Error saving: ' + e.message);
            }
        }
        
        async function deleteQuote(id) {
            if (!confirm('Delete quote #' + id + '? This cannot be undone.')) return;
            
            try {
                var res = await fetch(API_BASE + '/api/admin/quote/' + id + '?secret=' + encodeURIComponent(apiSecret), {
                    method: 'DELETE'
                });
                
                if (!res.ok) throw new Error('Failed to delete');
                
                showQuoteMessage('Deleted quote #' + id, 'success');
                loadQuotes(currentQuotePage);
                
            } catch (e) {
                alert('Error deleting: ' + e.message);
            }
        }
        
        function showQuoteMessage(text, type) {
            var msg = document.getElementById('quote-message');
            msg.className = 'message ' + type;
            msg.textContent = text;
            msg.style.display = 'block';
            setTimeout(function() { msg.style.display = 'none'; }, 3000);
        }
        
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function login() {
            apiSecret = document.getElementById('secret').value;
            const errDiv = document.getElementById('login-error');
            
            try {
                const res = await fetch(API_BASE + '/api/admin/subscribers?secret=' + encodeURIComponent(apiSecret));
                
                if (res.ok) {
                    document.getElementById('login-box').classList.remove('active');
                    document.getElementById('admin-panel').classList.add('active');
                    loadData();
                } else {
                    errDiv.className = 'message error';
                    errDiv.textContent = 'Invalid API Secret';
                }
            } catch (e) {
                errDiv.className = 'message error';
                errDiv.textContent = 'Connection error';
            }
        }
        
        function logout() {
            apiSecret = '';
            document.getElementById('admin-panel').classList.remove('active');
            document.getElementById('login-box').classList.add('active');
            document.getElementById('secret').value = '';
        }
        
        async function loadData() {
            try {
                const res = await fetch(API_BASE + '/api/admin/subscribers?secret=' + encodeURIComponent(apiSecret));
                const data = await res.json();
                
                // Update stats
                document.getElementById('stat-active').textContent = data.stats.active_subscribers || 0;
                document.getElementById('stat-total').textContent = data.stats.total_users || 0;
                document.getElementById('stat-readings').textContent = data.stats.total_readings || 0;
                
                // Update table
                const tbody = document.getElementById('users-table');
                if (!data.users || data.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">No subscribers yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.users.map(function(u) {
                    return '<tr>' +
                        '<td>' + u.email + '</td>' +
                        '<td>' + (u.name || '-') + '</td>' +
                        '<td>' +
                            '<select class="status-select" onchange="changeStatus(\'' + u.email + '\', this.value)">' +
                                '<option value="active"' + (u.status === 'active' ? ' selected' : '') + '>Active</option>' +
                                '<option value="cancelled"' + (u.status === 'cancelled' ? ' selected' : '') + '>Cancelled</option>' +
                                '<option value="none"' + (u.status === 'none' ? ' selected' : '') + '>None</option>' +
                            '</select>' +
                        '</td>' +
                        '<td>' + (u.has_birth_data ? 'Yes' : '-') + '</td>' +
                        '<td class="actions">' +
                            '<button class="btn-small btn-danger" onclick="deleteUser(\'' + u.email + '\')">Delete</button>' +
                        '</td>' +
                    '</tr>';
                }).join('');
                
            } catch (e) {
                console.error(e);
            }
        }
        
        document.getElementById('add-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            var email = document.getElementById('new-email').value;
            var name = document.getElementById('new-name').value;
            var msg = document.getElementById('message');
            
            try {
                var res = await fetch(API_BASE + '/api/admin/add-subscriber?secret=' + encodeURIComponent(apiSecret), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email, name: name })
                });
                
                if (res.ok) {
                    msg.className = 'message success';
                    msg.textContent = 'Added ' + email;
                    document.getElementById('new-email').value = '';
                    document.getElementById('new-name').value = '';
                    loadData();
                    setTimeout(function() { msg.style.display = 'none'; }, 3000);
                } else {
                    var err = await res.json();
                    msg.className = 'message error';
                    msg.textContent = err.detail || 'Error';
                }
            } catch (e) {
                msg.className = 'message error';
                msg.textContent = 'Connection error';
            }
        });
        
        // Add Quote form handler
        document.getElementById('add-quote-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            var text = document.getElementById('quote-text').value;
            var quoteDate = document.getElementById('quote-date').value;
            var quoteTime = document.getElementById('quote-time').value || null;
            var msg = document.getElementById('message');
            
            try {
                var res = await fetch(API_BASE + '/api/admin/add-quote?secret=' + encodeURIComponent(apiSecret), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: text, date: quoteDate, time: quoteTime })
                });
                
                if (res.ok) {
                    var result = await res.json();
                    msg.className = 'message success';
                    msg.textContent = result.message + (result.is_high_fidelity ? ' (high-fidelity üì°)' : ' (analog)');
                    document.getElementById('quote-text').value = '';
                    document.getElementById('quote-date').value = '';
                    document.getElementById('quote-time').value = '';
                    setTimeout(function() { msg.style.display = 'none'; }, 5000);
                } else {
                    var err = await res.json();
                    msg.className = 'message error';
                    msg.textContent = err.detail || 'Error adding quote';
                }
            } catch (e) {
                msg.className = 'message error';
                msg.textContent = 'Connection error';
            }
        });
        
        async function changeStatus(email, status) {
            var msg = document.getElementById('message');
            try {
                var res = await fetch(API_BASE + '/api/admin/update-status?secret=' + encodeURIComponent(apiSecret), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email, status: status })
                });
                
                if (res.ok) {
                    msg.className = 'message success';
                    msg.textContent = 'Updated ' + email + ' to ' + status;
                    loadData();
                    setTimeout(function() { msg.style.display = 'none'; }, 3000);
                } else {
                    msg.className = 'message error';
                    msg.textContent = 'Error updating status';
                    loadData();
                }
            } catch (e) {
                msg.className = 'message error';
                msg.textContent = 'Connection error';
            }
        }
        
        async function deleteUser(email) {
            if (!confirm('Delete ' + email + '? This cannot be undone.')) return;
            
            var msg = document.getElementById('message');
            try {
                var res = await fetch(API_BASE + '/api/admin/subscriber/' + encodeURIComponent(email) + '?secret=' + encodeURIComponent(apiSecret), {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    msg.className = 'message success';
                    msg.textContent = 'Deleted ' + email;
                    loadData();
                    setTimeout(function() { msg.style.display = 'none'; }, 3000);
                } else {
                    msg.className = 'message error';
                    msg.textContent = 'Error deleting user';
                }
            } catch (e) {
                msg.className = 'message error';
                msg.textContent = 'Connection error';
            }
        }
        
        // ========== BACKUP & RESTORE ==========
        
        async function backupSubscribers() {
            var msg = document.getElementById('message');
            try {
                var res = await fetch(API_BASE + '/api/admin/backup/subscribers?secret=' + encodeURIComponent(apiSecret));
                if (res.ok) {
                    var data = await res.json();
                    downloadJSON(data, 'bozo_subscribers_backup_' + new Date().toISOString().slice(0,10) + '.json');
                    msg.className = 'message success';
                    msg.textContent = 'Downloaded backup with ' + data.users.length + ' users';
                    setTimeout(function() { msg.style.display = 'none'; }, 3000);
                } else {
                    msg.className = 'message error';
                    msg.textContent = 'Error downloading backup';
                }
            } catch (e) {
                msg.className = 'message error';
                msg.textContent = 'Connection error';
            }
        }
        
        async function backupQuotes() {
            var msg = document.getElementById('message');
            try {
                var res = await fetch(API_BASE + '/api/admin/backup/quotes?secret=' + encodeURIComponent(apiSecret));
                if (res.ok) {
                    var data = await res.json();
                    downloadJSON(data, 'bozo_quotes_backup_' + new Date().toISOString().slice(0,10) + '.json');
                    msg.className = 'message success';
                    msg.textContent = 'Downloaded backup with ' + data.quote_count + ' quotes';
                    setTimeout(function() { msg.style.display = 'none'; }, 3000);
                } else {
                    msg.className = 'message error';
                    msg.textContent = 'Error downloading backup';
                }
            } catch (e) {
                msg.className = 'message error';
                msg.textContent = 'Connection error';
            }
        }
        
        function downloadJSON(data, filename) {
            var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        async function restoreSubscribers(input) {
            if (!input.files || !input.files[0]) return;
            if (!confirm('This will restore/merge subscribers from the backup file. Continue?')) {
                input.value = '';
                return;
            }
            
            var msg = document.getElementById('message');
            var file = input.files[0];
            
            try {
                var text = await file.text();
                var data = JSON.parse(text);
                
                var res = await fetch(API_BASE + '/api/admin/restore/subscribers?secret=' + encodeURIComponent(apiSecret), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    var result = await res.json();
                    msg.className = 'message success';
                    msg.textContent = result.message;
                    loadData();
                    setTimeout(function() { msg.style.display = 'none'; }, 5000);
                } else {
                    var err = await res.json();
                    msg.className = 'message error';
                    msg.textContent = err.detail || 'Error restoring backup';
                }
            } catch (e) {
                msg.className = 'message error';
                msg.textContent = 'Error reading file: ' + e.message;
            }
            input.value = '';
        }
        
        async function restoreQuotes(input) {
            if (!input.files || !input.files[0]) return;
            if (!confirm('This will REPLACE the entire quotes database. Are you sure?')) {
                input.value = '';
                return;
            }
            
            var msg = document.getElementById('message');
            var file = input.files[0];
            
            try {
                var text = await file.text();
                var data = JSON.parse(text);
                
                var res = await fetch(API_BASE + '/api/admin/restore/quotes?secret=' + encodeURIComponent(apiSecret), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    var result = await res.json();
                    msg.className = 'message success';
                    msg.textContent = result.message;
                    setTimeout(function() { msg.style.display = 'none'; }, 5000);
                } else {
                    var err = await res.json();
                    msg.className = 'message error';
                    msg.textContent = err.detail || 'Error restoring quotes';
                }
            } catch (e) {
                msg.className = 'message error';
                msg.textContent = 'Error reading file: ' + e.message;
            }
            input.value = '';
        }
        
        // Enter key to login
        document.getElementById('secret').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
